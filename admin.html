<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Админ: ДЗ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; color: #333; }
    .container { max-width: 900px; margin: 40px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
    .login { text-align: center; margin-bottom: 30px; }
    input[type="password"] { padding: 12px; width: 250px; border: 1px solid #ddd; border-radius: 6px; }
    button { padding: 12px 24px; background: #27aae1; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
    button:hover { background: #1e93c7; }
    .stats { display: flex; gap: 20px; margin: 30px 0; flex-wrap: wrap; }
    .stat-card { flex: 1; min-width: 180px; background: #eef5ff; padding: 20px; border-radius: 10px; text-align: center; }
    .stat-card h3 { color: #2c3e50; margin-bottom: 8px; }
    .stat-card p { font-size: 1.8em; font-weight: bold; color: #27aae1; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f8f9fa; }
    .hidden { display: none; }
    .error { color: #e74c3c; text-align: center; margin: 20px 0; }
  </style>
</head>
<body>
<div class="container">
  <h1>Админ: Записи на ДЗ</h1>
  
  <!-- Логин -->
  <div id="login-form" class="login">
    <input type="password" id="password" placeholder="Пароль" />
    <button onclick="login()">Войти</button>
    <p id="error" class="error" style="display:none;">Неверный пароль</p>
  </div>

  <!-- Контент -->
  <div id="content" class="hidden">
    <div class="stats">
      <div class="stat-card"><h3>Всего</h3><p id="total">0</p></div>
      <div class="stat-card"><h3>Ближайший ВТ</h3><p id="next">—</p></div>
      <div class="stat-card"><h3>Мест осталось</h3><p id="left">—</p></div>
    </div>
    <button onclick="loadData()">Обновить</button>
    <div id="records">Загрузка...</div>
  </div>
</div>

<script>
  const PASSWORD = "0000";
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdkS8qxjx2EcZayyE2WDTPlZskq6qYBu0ScDTlI_EVjnqRV9UMewkUm8R0diAuFop5/exec";

  function login() {
    const input = document.getElementById('password').value;
    if (input === PASSWORD) {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
      loadData();
    } else {
      document.getElementById('error').style.display = 'block';
    }
  }

  async function loadData() {
    const recordsEl = document.getElementById('records');
    recordsEl.innerHTML = "Загрузка...";

    try {
      const response = await fetch(GOOGLE_SCRIPT_URL + "?t=" + Date.now());
      if (!response.ok) throw new Error("Сервер не отвечает");
      
      const records = await response.json();
      if (!Array.isArray(records)) throw new Error("Неверный формат данных");

      const grouped = {};
      records.forEach(r => {
        const date = r["Дата"] || "Без даты";
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(r);
      });

      let total = 0;
      let html = '';
      const dates = Object.keys(grouped).sort();
      const nextDate = dates[0] || '—';
      const nextCount = grouped[nextDate]?.length || 0;

      dates.forEach(date => {
        const list = grouped[date];
        total += list.length;
        html += `<div style="margin:30px 0;">
          <h3>${date} — ${list.length}/20 мест</h3>
          <table>
            <thead><tr><th>№</th><th>Студент</th><th>Родитель</th><th>Группа</th><th>Телефон</th><th>Время</th></tr></thead>
            <tbody>`;
        list.forEach((r, i) => {
          html += `<tr>
            <td>${i+1}</td>
            <td>${r["Студент"] || '—'}</td>
            <td>${r["Родитель"] || '—'}</td>
            <td>${r["Группа"] || '—'}</td>
            <td>${r["Телефон"] || '—'}</td>
            <td>${r["Время записи"] || '—'}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      });

      document.getElementById('total').textContent = total;
      document.getElementById('next').textContent = nextDate;
      document.getElementById('left').textContent = 20 - nextCount;
      recordsEl.innerHTML = html || '<p style="text-align:center; color:#777;">Записей нет</p>';

    } catch (error) {
      console.error("Ошибка:", error);
      recordsEl.innerHTML = `<p class="error">Ошибка загрузки: ${error.message}</p>`;
    }
  }

  // Вход по Enter
  document.getElementById('password').addEventListener('keypress', e => {
    if (e.key === 'Enter') login();
  });
</script>
</body>
</html>
